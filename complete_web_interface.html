<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTServo Complete Control System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            justify-content: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e53e3e;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #48bb78;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            font-size: 1.3rem;
        }

        .button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }

        .button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .button.danger {
            background: #e53e3e;
        }

        .button.danger:hover {
            background: #c53030;
        }

        .button.success {
            background: #48bb78;
        }

        .button.warning {
            background: #ed8936;
        }

        .servo-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .servo-item:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }

        .servo-item.selected {
            background: #bee3f8;
            border-color: #4299e1;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
            transition: background 0.3s;
        }

        .slider:hover {
            background: #cbd5e0;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4299e1;
            cursor: pointer;
            transition: background 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #3182ce;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4299e1;
            cursor: pointer;
            transition: background 0.3s;
        }

        .slider::-moz-range-thumb:hover {
            background: #3182ce;
        }

        .slider-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #4a5568;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .input-slider-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-slider-group input[type="number"] {
            flex: 0 0 80px;
        }

        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 1s infinite;
        }

        .realtime-active {
            color: #48bb78;
            font-weight: bold;
        }

        .control-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-button {
            flex: 1;
            padding: 8px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-button.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .status-display {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .status-item span:first-child {
            color: #718096;
        }

        .status-item span:last-child {
            font-weight: bold;
            color: #2d3748;
        }

        .log {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 3px;
        }

        .log-entry.info { color: #63b3ed; }
        .log-entry.success { color: #68d391; }
        .log-entry.warning { color: #f6e05e; }
        .log-entry.error { color: #fc8181; }

        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .memory-address-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .memory-address-input input {
            flex: 1;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 1s infinite;
        }

        .monitoring-active {
            color: #48bb78;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ FTServo Complete Control System</h1>
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="connectionStatus">Disconnected</span>
                <span id="monitoringStatus" style="display: none;" class="monitoring-active">
                    üì° Real-time Monitoring<span class="realtime-indicator"></span>
                </span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Â∑¶‰æßÈù¢Êùø - ËàµÊú∫ÂàóË°® -->
            <div class="panel">
                <h2>üîß Servo List</h2>
                <button class="button" onclick="scanServos()">üîç Scan Servos</button>
                <button class="button success" onclick="startMonitoring()">‚ñ∂Ô∏è Start Real-time</button>
                <button class="button danger" onclick="stopMonitoring()">‚èπÔ∏è Stop Monitoring</button>
                <div id="servoList">
                    <p style="color: #718096; text-align: center; padding: 20px;">
                        Click "Scan Servos" to discover connected servos
                    </p>
                </div>
            </div>

            <!-- ‰∏≠Èó¥Èù¢Êùø - ÊéßÂà∂Èù¢Êùø -->
            <div class="panel">
                <h2>üéõÔ∏è Control Panel</h2>
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('basic')">Basic Control</button>
                    <button class="tab" onclick="switchTab('pid')">PID Parameters</button>
                    <button class="tab" onclick="switchTab('advanced')">Advanced</button>
                    <button class="tab" onclick="switchTab('memory')">Memory Access</button>
                </div>

                <!-- Âü∫Á°ÄÊéßÂà∂ -->
                <div id="basic-tab" class="tab-content active">
                    <div id="controlPanel">
                        <p style="color: #718096; text-align: center; padding: 20px;">
                            Select a servo to control
                        </p>
                    </div>
                </div>

                <!-- PIDÊéßÂà∂ -->
                <div id="pid-tab" class="tab-content">
                    <div id="pidPanel">
                        <p style="color: #718096; text-align: center; padding: 20px;">
                            Select a servo to configure PID parameters
                        </p>
                    </div>
                </div>

                <!-- È´òÁ∫ßÂäüËÉΩ -->
                <div id="advanced-tab" class="tab-content">
                    <div id="advancedPanel">
                        <p style="color: #718096; text-align: center; padding: 20px;">
                            Select a servo for advanced settings
                        </p>
                    </div>
                </div>

                <!-- ÂÜÖÂ≠òËÆøÈóÆ -->
                <div id="memory-tab" class="tab-content">
                    <div id="memoryPanel">
                        <p style="color: #718096; text-align: center; padding: 20px;">
                            Select a servo for memory access
                        </p>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßÈù¢Êùø - Áä∂ÊÄÅÊòæÁ§∫ -->
            <div class="panel">
                <h2>üìä Status Monitor</h2>
                <button class="button" onclick="refreshSelectedStatus()">üîÑ Refresh Status</button>
                <div id="statusPanel">
                    <p style="color: #718096; text-align: center; padding: 20px;">
                        Select a servo to view status
                    </p>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®Èù¢Êùø - Êó•Âøó -->
        <div class="panel">
            <h2>üìù System Log</h2>
            <div class="log" id="logContent">
                <div class="log-entry info">[System] Initialized, ready to connect...</div>
            </div>
        </div>
    </div>

    <script>
        class FTServoCompleteController {
            constructor() {
                this.ws = null;
                this.selectedServoId = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.monitoringInterval = null;
                this.monitoringActive = false;

                // ÂÆûÊó∂ÊéßÂà∂Áõ∏ÂÖ≥ÂèòÈáè
                this.controlMode = 'manual'; // 'manual' Êàñ 'realtime'
                this.realtimeEnabled = false;
                this.lastMoveTime = 0;
                this.moveDebounceDelay = 50; // 50msÈò≤ÊäñÂª∂Ëøü

                this.init();
            }

            init() {
                this.connect();
                this.addLog('[System] Initialized, ready to connect...', 'info');
            }

            connect() {
                this.ws = new WebSocket('ws://localhost:8765');

                this.ws.onopen = () => {
                    this.addLog('[WebSocket] Connection established', 'success');
                    this.updateConnectionStatus(true);
                    this.reconnectAttempts = 0;
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = () => {
                    this.addLog('[WebSocket] Connection lost', 'warning');
                    this.updateConnectionStatus(false);
                    this.attemptReconnect();
                };

                this.ws.onerror = (error) => {
                    this.addLog(`[WebSocket] Error: ${error}`, 'error');
                    this.updateConnectionStatus(false);
                };
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    this.addLog(`[System] Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'info');
                    setTimeout(() => this.connect(), 3000);
                } else {
                    this.addLog('[System] Max reconnect attempts reached', 'error');
                }
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'connection':
                        this.handleConnection(message);
                        break;
                    case 'scan_result':
                        this.handleScanResult(message);
                        break;
                    case 'servo_status':
                        this.handleServoStatus(message);
                        break;
                    case 'move_result':
                        this.handleMoveResult(message);
                        break;
                    case 'memory_read':
                        this.handleMemoryRead(message);
                        break;
                    case 'firmware_info':
                        this.handleFirmwareInfo(message);
                        break;
                    case 'pid_params':
                        this.handlePidParams(message);
                        break;
                    case 'temperature_limit_read':
                        this.handleTemperatureLimit(message);
                        break;
                    case 'error':
                        this.addLog(`[Server] Error: ${message.message}`, 'error');
                        break;
                    default:
                        this.addLog(`[System] Unknown message type: ${message.type}`, 'warning');
                }
            }

            handleConnection(message) {
                this.addLog(`[System] Server connection: ${message.status}`,
                           message.status === 'connected' ? 'success' : 'info');
            }

            handleScanResult(message) {
                this.addLog(`[Scan] Complete: found ${message.count} servos`, 'success');
                this.displayServoList(message.servos);
            }

            handleServoStatus(message) {
                this.updateServoStatus(message.status);
                if (this.monitoringActive) {
                    this.addLog(`[Monitor] Servo ${message.servo_id} status updated`, 'info');
                }
            }

            handleMoveResult(message) {
                if (message.success) {
                    this.addLog(`[Control] Servo ${message.servo_id} move command successful`, 'success');
                } else {
                    this.addLog(`[Control] Servo ${message.servo_id} move failed: ${message.error}`, 'error');
                }
            }

            handleMemoryRead(message) {
                if (message.success) {
                    this.addLog(`[Memory] Address ${message.address}: ${message.data}`, 'success');
                } else {
                    this.addLog(`[Memory] Read failed: ${message.error}`, 'error');
                }
            }

            handleFirmwareInfo(message) {
                this.addLog(`[Firmware] Servo ${message.servo_id} info retrieved`, 'success');
                this.updateFirmwareInfo(message.info);
            }

            handlePidParams(message) {
                this.addLog(`[PID] Servo ${message.servo_id} parameters retrieved`, 'success');
                this.updatePidParams(message.params);
            }

            handleTemperatureLimit(message) {
                if (message.success) {
                    this.addLog(`[Temperature] Limit: ${message.limit}¬∞C`, 'success');
                    document.getElementById('tempLimitValue').textContent = message.limit;
                } else {
                    this.addLog(`[Temperature] Failed to read limit: ${message.error}`, 'error');
                }
            }

            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                    return true;
                }
                this.addLog('[WebSocket] Cannot send message: not connected', 'error');
                return false;
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('statusIndicator');
                const status = document.getElementById('connectionStatus');

                if (connected) {
                    indicator.classList.add('connected');
                    status.textContent = 'Connected';
                } else {
                    indicator.classList.remove('connected');
                    status.textContent = 'Disconnected';
                }
            }

            displayServoList(servos) {
                const listContainer = document.getElementById('servoList');
                listContainer.innerHTML = '';

                servos.forEach(servo => {
                    const servoElement = document.createElement('div');
                    servoElement.className = 'servo-item';
                    servoElement.onclick = () => this.selectServo(servo.id);

                    servoElement.innerHTML = `
                        <div><strong>ID: ${servo.id}</strong></div>
                        <div style="color: #718096; font-size: 0.8rem;">Model: ${servo.model_number}</div>
                        <div style="color: #48bb78; font-size: 0.8rem;">Status: Connected</div>
                    `;

                    listContainer.appendChild(servoElement);
                });
            }

            selectServo(servoId) {
                this.selectedServoId = servoId;

                // Êõ¥Êñ∞UIÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.servo-item').forEach(item => {
                    item.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');

                // ÊòæÁ§∫ÊâÄÊúâÊéßÂà∂Èù¢Êùø
                this.showControlPanel();
                this.showPidPanel();
                this.showAdvancedPanel();
                this.showMemoryPanel();

                // Ëé∑ÂèñËàµÊú∫Áä∂ÊÄÅ
                this.getServoStatus(servoId);
                this.getFirmwareInfo(servoId);
                this.getPidParams(servoId);
                this.getTemperatureLimit(servoId);

                this.addLog(`[Control] Selected servo ${servoId}`, 'info');
            }

            showControlPanel() {
                const controlPanel = document.getElementById('controlPanel');
                controlPanel.innerHTML = `
                    <h3>üéõÔ∏è Servo ${this.selectedServoId} Real-time Control</h3>

                    <!-- ÊéßÂà∂Ê®°ÂºèÂàáÊç¢ -->
                    <div class="control-mode-toggle">
                        <button class="mode-button active" id="manualMode" onclick="setControlMode('manual')">
                            üéØ Manual Mode
                        </button>
                        <button class="mode-button" id="realtimeMode" onclick="setControlMode('realtime')">
                            ‚ö° Real-time Mode
                        </button>
                    </div>

                    <!-- ‰ΩçÁΩÆÊéßÂà∂ -->
                    <div class="control-group">
                        <label>Position (0-4095) <span id="realtimeIndicator" style="display: none;" class="realtime-active">‚ö° Live<span class="realtime-indicator"></span></span></label>
                        <div class="slider-container">
                            <input type="range" id="positionSlider" class="slider" min="0" max="4095" value="2048" oninput="updatePositionFromSlider(this.value)">
                            <span class="slider-value" id="positionValue">2048</span>
                        </div>
                        <div class="input-slider-group">
                            <input type="number" id="positionInput" min="0" max="4095" value="2048" onchange="updatePositionFromInput(this.value)">
                            <button class="button" onclick="moveServo()" id="moveButton">üöÄ Move to Position</button>
                        </div>
                    </div>

                    <!-- ÈÄüÂ∫¶ÊéßÂà∂ -->
                    <div class="control-group">
                        <label>Speed (0-2047)</label>
                        <div class="slider-container">
                            <input type="range" id="speedSlider" class="slider" min="0" max="2047" value="100" oninput="updateSpeedFromSlider(this.value)">
                            <span class="slider-value" id="speedValue">100</span>
                        </div>
                        <div class="input-slider-group">
                            <input type="number" id="speedInput" min="0" max="2047" value="100" onchange="updateSpeedFromInput(this.value)">
                        </div>
                    </div>

                    <!-- Âä†ÈÄüÂ∫¶ÊéßÂà∂ -->
                    <div class="control-group">
                        <label>Acceleration (0-255)</label>
                        <div class="slider-container">
                            <input type="range" id="accelSlider" class="slider" min="0" max="255" value="50" oninput="updateAccelFromSlider(this.value)">
                            <span class="slider-value" id="accelValue">50</span>
                        </div>
                        <div class="input-slider-group">
                            <input type="number" id="accelInput" min="0" max="255" value="50" onchange="updateAccelFromInput(this.value)">
                        </div>
                    </div>

                    <!-- Âø´ÈÄü‰ΩçÁΩÆÊåâÈíÆ -->
                    <div class="control-group">
                        <label>Quick Position Presets</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;">
                            <button class="button" onclick="setPosition(0)">0¬∞</button>
                            <button class="button" onclick="setPosition(1024)">90¬∞</button>
                            <button class="button" onclick="setPosition(2048)">180¬∞</button>
                            <button class="button" onclick="setPosition(3072)">270¬∞</button>
                            <button class="button" onclick="setPosition(512)">45¬∞</button>
                            <button class="button" onclick="setPosition(1536)">135¬∞</button>
                            <button class="button" onclick="setPosition(2560)">225¬∞</button>
                            <button class="button" onclick="setPosition(3584)">315¬∞</button>
                        </div>
                    </div>

                    <button class="button danger" onclick="stopServo()">‚èπÔ∏è Stop Servo</button>
                    <button class="button success" onclick="readTemperature()">üå°Ô∏è Read Temperature</button>
                `;

                // ÂàùÂßãÂåñÂÆûÊó∂ÊéßÂà∂
                this.initRealtimeControl();
            }

            showPidPanel() {
                const pidPanel = document.getElementById('pidPanel');
                pidPanel.innerHTML = `
                    <h3>‚öôÔ∏è Servo ${this.selectedServoId} PID Parameters</h3>

                    <div class="param-grid">
                        <div class="control-group">
                            <label>Position P</label>
                            <input type="number" id="posP" min="0" max="255" value="32">
                        </div>
                        <div class="control-group">
                            <label>Position I</label>
                            <input type="number" id="posI" min="0" max="255" value="0">
                        </div>
                        <div class="control-group">
                            <label>Position D</label>
                            <input type="number" id="posD" min="0" max="255" value="32">
                        </div>
                        <div class="control-group">
                            <label>Speed P</label>
                            <input type="number" id="speedP" min="0" max="255" value="10">
                        </div>
                        <div class="control-group">
                            <label>Speed I</label>
                            <input type="number" id="speedI" min="-32768" max="32767" value="200">
                        </div>
                        <div class="control-group">
                            <label>Startup Torque</label>
                            <input type="number" id="startupTorque" min="0" max="255" value="100">
                        </div>
                    </div>

                    <button class="button" onclick="readPidParams()">üìñ Read PID Parameters</button>
                    <button class="button success" onclick="writePidParams()">üíæ Save PID Parameters</button>
                `;
            }

            showAdvancedPanel() {
                const advancedPanel = document.getElementById('advancedPanel');
                advancedPanel.innerHTML = `
                    <h3>üîß Servo ${this.selectedServoId} Advanced Settings</h3>

                    <div class="control-group">
                        <label>Temperature Limit (¬∞C)</label>
                        <input type="number" id="tempLimit" min="0" max="150" value="70">
                        <button class="button warning" onclick="readTemperatureLimit()">üìñ Read Limit</button>
                        <button class="button success" onclick="writeTemperatureLimit()">üíæ Save Limit</button>
                    </div>

                    <button class="button" onclick="getFirmwareInfo()">üîç Get Firmware Info</button>
                    <button class="button" onclick="calibrateServo()">üîß Calibrate Servo</button>
                `;
            }

            showMemoryPanel() {
                const memoryPanel = document.getElementById('memoryPanel');
                memoryPanel.innerHTML = `
                    <h3>üíæ Servo ${this.selectedServoId} Memory Access</h3>

                    <div class="memory-address-input">
                        <input type="number" id="memAddress" min="0" max="255" placeholder="Address (0-255)">
                        <input type="number" id="memLength" min="1" max="10" value="1" placeholder="Length">
                        <button class="button" onclick="readMemory()">üìñ Read</button>
                    </div>

                    <div class="control-group">
                        <label>Write Data (Hex, space separated)</label>
                        <input type="text" id="memWriteData" placeholder="e.g., FF 0A 1B">
                        <button class="button danger" onclick="writeMemory()">üíæ Write</button>
                    </div>

                    <div class="control-group">
                        <label>Quick Access Addresses:</label>
                        <button class="button" onclick="quickRead(63)">üå°Ô∏è Temperature (63)</button>
                        <button class="button" onclick="quickRead(13)">üî• Temp Limit (13)</button>
                        <button class="button" onclick="quickRead(62)">‚ö° Voltage (62)</button>
                        <button class="button" onclick="quickRead(66)">‚ùå Error Status (66)</button>
                    </div>
                `;
            }

            updateServoStatus(status) {
                if (!status || status.id !== this.selectedServoId) return;

                const statusPanel = document.getElementById('statusPanel');
                statusPanel.innerHTML = `
                    <h3>üìä Servo ${status.id} Real-time Status</h3>
                    <div class="status-display">
                        <div class="status-item">
                            <span>Connected:</span>
                            <span>${status.connected ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                        <div class="status-item">
                            <span>Model:</span>
                            <span>${status.model_number || 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Position:</span>
                            <span>${status.position || 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Speed:</span>
                            <span>${status.speed || 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Temperature:</span>
                            <span>${status.temperature ? status.temperature + '¬∞C' : 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Voltage:</span>
                            <span>${status.voltage ? status.voltage.toFixed(1) + 'V' : 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Current:</span>
                            <span>${status.current ? status.current + 'mA' : 'N/A'}</span>
                        </div>
                        <div class="status-item">
                            <span>Last Update:</span>
                            <span>${new Date(status.timestamp * 1000).toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;
            }

            updateFirmwareInfo(info) {
                if (info && info.servo_id === this.selectedServoId) {
                    // ÂèØ‰ª•Âú®Áä∂ÊÄÅÈù¢ÊùøÊàñÂçïÁã¨ÊòæÁ§∫Âõ∫‰ª∂‰ø°ÊÅØ
                    this.addLog(`[Firmware] V${info.firmware_major}.${info.firmware_minor}, Hardware V${info.hardware_major}.${info.hardware_minor}`, 'info');
                }
            }

            updatePidParams(params) {
                if (params && params.servo_id === this.selectedServoId) {
                    // Êõ¥Êñ∞PIDÈù¢ÊùøÁöÑËæìÂÖ•ÂÄº
                    const elements = {
                        'posP': params.position_pid.P,
                        'posI': params.position_pid.I,
                        'posD': params.position_pid.D,
                        'speedP': params.speed_pid.P,
                        'speedI': params.speed_pid.I,
                        'startupTorque': params.startup_torque
                    };

                    for (const [id, value] of Object.entries(elements)) {
                        const element = document.getElementById(id);
                        if (element && value !== null) {
                            element.value = value;
                        }
                    }
                }
            }

            startMonitoring() {
                if (this.monitoringActive || !this.selectedServoId) {
                    this.addLog('[Monitor] Please select a servo first', 'warning');
                    return;
                }

                this.monitoringActive = true;
                document.getElementById('monitoringStatus').style.display = 'inline-block';

                this.monitoringInterval = setInterval(() => {
                    if (this.selectedServoId) {
                        this.getServoStatus(this.selectedServoId);
                    }
                }, 1000); // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°

                this.addLog('[Monitor] Real-time monitoring started', 'success');
            }

            stopMonitoring() {
                this.monitoringActive = false;
                document.getElementById('monitoringStatus').style.display = 'none';

                if (this.monitoringInterval) {
                    clearInterval(this.monitoringInterval);
                    this.monitoringInterval = null;
                }

                this.addLog('[Monitor] Real-time monitoring stopped', 'info');
            }

            // ÂÆûÊó∂ÊéßÂà∂ÊñπÊ≥ï
            initRealtimeControl() {
                this.realtimeEnabled = false;
                this.updateControlModeUI();
            }

            setControlMode(mode) {
                this.controlMode = mode;
                this.realtimeEnabled = (mode === 'realtime');
                this.updateControlModeUI();

                if (this.realtimeEnabled) {
                    this.addLog('[Control] Real-time mode enabled - drag sliders to control', 'success');
                    document.getElementById('realtimeIndicator').style.display = 'inline';
                } else {
                    this.addLog('[Control] Manual mode enabled - click "Move to Position"', 'info');
                    document.getElementById('realtimeIndicator').style.display = 'none';
                }
            }

            updateControlModeUI() {
                const manualBtn = document.getElementById('manualMode');
                const realtimeBtn = document.getElementById('realtimeMode');
                const moveBtn = document.getElementById('moveButton');

                if (this.controlMode === 'realtime') {
                    manualBtn.classList.remove('active');
                    realtimeBtn.classList.add('active');
                    if (moveBtn) moveBtn.textContent = '‚ö° Real-time Control Active';
                } else {
                    manualBtn.classList.add('active');
                    realtimeBtn.classList.remove('active');
                    if (moveBtn) moveBtn.textContent = 'üöÄ Move to Position';
                }
            }

            moveServoRealtime(position, speed, acceleration) {
                // Èò≤ÊäñÂ§ÑÁêÜ
                const now = Date.now();
                if (now - this.lastMoveTime < this.moveDebounceDelay) {
                    return;
                }
                this.lastMoveTime = now;

                if (!this.selectedServoId) {
                    return;
                }

                this.sendMessage({
                    type: 'move_servo',
                    servo_id: this.selectedServoId,
                    position: parseInt(position),
                    speed: parseInt(speed),
                    acceleration: parseInt(acceleration)
                });
            }

            addLog(message, type = 'info') {
                const logContent = document.getElementById('logContent');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;

                logContent.appendChild(logEntry);
                logContent.scrollTop = logContent.scrollHeight;

                // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
                const entries = logContent.children;
                if (entries.length > 100) {
                    logContent.removeChild(entries[0]);
                }
            }
        }

        // ÂÖ®Â±ÄÊéßÂà∂Âô®ÂÆû‰æã
        let controller;

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            controller = new FTServoCompleteController();
        });

        // TabÂàáÊç¢ÂäüËÉΩ
        function switchTab(tabName) {
            // Êõ¥Êñ∞tabÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Êõ¥Êñ∞tabÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ÂÖ®Â±ÄÂäüËÉΩÂáΩÊï∞
        function scanServos() {
            controller.sendMessage({
                type: 'scan_servos',
                start_id: 1,
                end_id: 20
            });
        }

        // ÂÆûÊó∂ÊéßÂà∂ÂáΩÊï∞
        function setControlMode(mode) {
            controller.setControlMode(mode);
        }

        function updatePositionFromSlider(value) {
            document.getElementById('positionValue').textContent = value;
            document.getElementById('positionInput').value = value;

            if (controller.realtimeEnabled && controller.selectedServoId) {
                const speed = document.getElementById('speedSlider').value;
                const acceleration = document.getElementById('accelSlider').value;
                controller.moveServoRealtime(value, speed, acceleration);
            }
        }

        function updatePositionFromInput(value) {
            document.getElementById('positionSlider').value = value;
            document.getElementById('positionValue').textContent = value;
        }

        function updateSpeedFromSlider(value) {
            document.getElementById('speedValue').textContent = value;
            document.getElementById('speedInput').value = value;
        }

        function updateSpeedFromInput(value) {
            document.getElementById('speedSlider').value = value;
            document.getElementById('speedValue').textContent = value;
        }

        function updateAccelFromSlider(value) {
            document.getElementById('accelValue').textContent = value;
            document.getElementById('accelInput').value = value;
        }

        function updateAccelFromInput(value) {
            document.getElementById('accelSlider').value = value;
            document.getElementById('accelValue').textContent = value;
        }

        function setPosition(value) {
            document.getElementById('positionSlider').value = value;
            document.getElementById('positionInput').value = value;
            document.getElementById('positionValue').textContent = value;

            if (controller.realtimeEnabled && controller.selectedServoId) {
                const speed = document.getElementById('speedSlider').value;
                const acceleration = document.getElementById('accelSlider').value;
                controller.moveServoRealtime(value, speed, acceleration);
            }
        }

        function startMonitoring() {
            controller.startMonitoring();
        }

        function stopMonitoring() {
            controller.stopMonitoring();
        }

        function refreshSelectedStatus() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.getServoStatus(controller.selectedServoId);
        }

        function moveServo() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            const position = parseInt(document.getElementById('positionInput').value);
            const speed = parseInt(document.getElementById('speedInput').value);
            const acceleration = parseInt(document.getElementById('accelInput').value);

            controller.sendMessage({
                type: 'move_servo',
                servo_id: controller.selectedServoId,
                position: position,
                speed: speed,
                acceleration: acceleration
            });
        }

        function stopServo() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            controller.sendMessage({
                type: 'stop_servo',
                servo_id: controller.selectedServoId
            });
        }

        function readTemperature() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.sendMessage({
                type: 'read_memory',
                servo_id: controller.selectedServoId,
                address: 63,
                length: 1
            });
        }

        function getServoStatus() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.sendMessage({
                type: 'get_servo_status',
                servo_id: controller.selectedServoId
            });
        }

        function getFirmwareInfo() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.sendMessage({
                type: 'get_firmware_info',
                servo_id: controller.selectedServoId
            });
        }

        function readPidParams() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.sendMessage({
                type: 'read_pid_params',
                servo_id: controller.selectedServoId
            });
        }

        function writePidParams() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            const position_pid = [
                parseInt(document.getElementById('posP').value),
                parseInt(document.getElementById('posI').value),
                parseInt(document.getElementById('posD').value)
            ];

            const speed_pid = [
                parseInt(document.getElementById('speedP').value),
                parseInt(document.getElementById('speedI').value)
            ];

            const startup_torque = parseInt(document.getElementById('startupTorque').value);

            controller.sendMessage({
                type: 'write_pid_params',
                servo_id: controller.selectedServoId,
                position_pid: position_pid,
                speed_pid: speed_pid,
                startup_torque: startup_torque
            });
        }

        function readTemperatureLimit() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }
            controller.sendMessage({
                type: 'read_temperature_limit',
                servo_id: controller.selectedServoId
            });
        }

        function writeTemperatureLimit() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            const temp_limit = parseInt(document.getElementById('tempLimit').value);
            controller.sendMessage({
                type: 'write_temperature_limit',
                servo_id: controller.selectedServoId,
                temp_limit: temp_limit
            });
        }

        function readMemory() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            const address = parseInt(document.getElementById('memAddress').value);
            const length = parseInt(document.getElementById('memLength').value);

            if (isNaN(address) || isNaN(length)) {
                alert('Please enter valid address and length');
                return;
            }

            controller.sendMessage({
                type: 'read_memory',
                servo_id: controller.selectedServoId,
                address: address,
                length: length
            });
        }

        function writeMemory() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            const address = parseInt(document.getElementById('memAddress').value);
            const data = document.getElementById('memWriteData').value;

            if (isNaN(address) || !data) {
                alert('Please enter valid address and data');
                return;
            }

            controller.sendMessage({
                type: 'write_memory',
                servo_id: controller.selectedServoId,
                address: address,
                data: data
            });
        }

        function quickRead(address) {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            controller.sendMessage({
                type: 'read_memory',
                servo_id: controller.selectedServoId,
                address: address,
                length: 1
            });
        }

        function calibrateServo() {
            if (!controller.selectedServoId) {
                alert('Please select a servo first');
                return;
            }

            // ÂèëÈÄÅÊ†°ÂáÜÂëΩ‰ª§ÔºàÁßªÂä®Âà∞‰∏≠Èó¥‰ΩçÁΩÆÔºâ
            controller.sendMessage({
                type: 'move_servo',
                servo_id: controller.selectedServoId,
                position: 2048,
                speed: 50,
                acceleration: 10
            });

            controller.addLog('[Calibration] Moving servo to center position (2048)', 'info');
        }

        // ‰∏∫controllerÂÆû‰æãÊ∑ªÂä†Ëé∑ÂèñÁä∂ÊÄÅÁöÑÂáΩÊï∞
        FTServoCompleteController.prototype.getServoStatus = function(servoId) {
            this.sendMessage({
                type: 'get_servo_status',
                servo_id: servoId
            });
        };

        FTServoCompleteController.prototype.getFirmwareInfo = function(servoId) {
            this.sendMessage({
                type: 'get_firmware_info',
                servo_id: servoId
            });
        };

        FTServoCompleteController.prototype.getPidParams = function(servoId) {
            this.sendMessage({
                type: 'read_pid_params',
                servo_id: servoId
            });
        };

        FTServoCompleteController.prototype.getTemperatureLimit = function(servoId) {
            this.sendMessage({
                type: 'read_temperature_limit',
                servo_id: servoId
            });
        };
    </script>
</body>
</html>